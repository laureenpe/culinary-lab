webpackJsonp([248],{2749:function(e,a){!function(){"use strict";TS.registerModule("recaps_signal",{sli_recaps_debug_group:null,onStart:function(){TS.client&&TS.boot_data.feature_sli_recaps&&(TS.experiment.loadUserAssignments().then(TS.recaps_signal.getExperimentGroup),TS.boot_data.feature_sli_highlights_cache||(TS.client.unread.switched_sig.add(c),TS.client.threads.switched_sig.add(c)))},getExperimentGroup:function(){TS.recaps_signal.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug")},canHaveHighlights:function(){return!(!TS.client||!TS.boot_data.feature_sli_recaps)},canHaveHighlightsUI:function(){return!!TS.boot_data.feature_sli_recaps_interface},channelAllowHighlights:function(){var e=TS.shared.getActiveModelOb();return!(e.is_mpim||e.is_im)},remove:function(){$("ts-message.is_recap").removeClass("show_recap")},setCurrentChannel:function(){if(TS.recaps_signal.canHaveHighlights()&&a!=TS.model.active_cid){a=TS.model.active_cid;var e=TS.shared.getActiveModelOb();t={count:e.unread_cnt,last_read_ts:e.last_read,oldest_unread_ts:TS.shared&&TS.shared.getOldestUnreadTsForId(e.id),channel_open_ts:TS.utility.date.makeTsStamp(new Date,"0")}}},retrieveHighlights:function(){if(TS.recaps_signal.canHaveHighlights()&&TS.recaps_signal.channelAllowHighlights()){var a=TS.shared.getActiveModelOb();e[a.id]||(e[a.id]=!0,TS.membership.promiseToGetMembershipCounts(a).then(function(e){if(!(e.member_count<5)||s[a.id])return u(a)}).finally(function(){delete e[a.id]}))}},renderHighlightedMessages:function(){if(TS.recaps_signal.canHaveHighlights()&&TS.recaps_signal.canHaveHighlightsUI()&&TS.recaps_signal.channelAllowHighlights()){TS.recaps_signal.remove();var e=l();if(e.length){var a=TS.client.ui.areMsgsScrolledToBottom(1);e.addClass("show_recap"),a&&TS.client.ui.instaScrollMsgsToBottom()}}},msgShouldBeHighlighted:function(e){return TS.recaps_signal.isMessageHighlight(e)&&h(e.ts)},sendFeedback:function(e,a,t,s){if(TS.recaps_signal.canHaveHighlights()){var r=TS.shared.getModelObById(s),c=TS.utility.msgs.getMsgByProp("ts",t,r.msgs),n=_.assign({},c);if(n.recap=_.assign({},c.recap),$(e.target).closest(".sli_briefing__feedback_controls").addClass("gave_"+a+"_feedback"),"negative"===a){n.recap.data.show_recap=!1,n.recap.data.is_leaving_feedback=!0,n.recap.data.feedback=a,TS.utility.msgs.replaceMsg(r,n);var d=_.get(c.recap.data,["feedback_options","default_negative","args"]);if(d){var g=_.assign({},d,{request_id:c.recap.data.request_id||i});c.recap.data.cached_request_id&&(g.cached_request_id=c.recap.data.cached_request_id),TS.api.call("highlights.feedback",g)}}else if("positive"===a){n.recap.data.feedback=a,TS.utility.msgs.replaceMsg(r,n),setTimeout(function(){$('ts-message[data-ts="'+n.ts+'"] [data-highlight-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse")},0);var l=_.get(c.recap.data,["feedback_options","default_positive","args"]);if(l){var o=_.assign({},l,{request_id:c.recap.data.request_id||i});c.recap.data.cached_request_id&&(o.cached_request_id=c.recap.data.cached_request_id),TS.api.call("highlights.feedback",o)}}}},handleSecondaryFeedbackClick:function(e,a,t){var s=TS.utility.msgs.getMsgByProp("ts",t,a.msgs),r=$("<ul></ul>");_.each(s.recap.data.feedback_options.negative,function(e){r.append('<li role="menuitem" data-js="highlights_feedback_item"><a href="#">'+TS.format.formatWithOptions(e.text,"",{no_linking:!0})+"</a></li>")}),TS.menu.startWithList(e,r,{close_on_click:!0,menu_class:"sli_briefing__menu",position_by_click:!0,onClick:function(e){e.preventDefault();var t=$(e.target).parents("li[data-js=highlights_feedback_item]").index(),r=_.assign({},s);r.recap=_.assign({},s.recap),r.recap.data.is_leaving_feedback=!1,r.recap.data.has_left_feedback=!0,TS.utility.msgs.replaceMsg(a,r);var c=_.get(s.recap.data,["feedback_options","negative",t,"args"]);if(c){var n=_.assign({},c,{request_id:s.recap.data.request_id||i});s.recap.data.cached_request_id&&(n.cached_request_id=s.recap.data.cached_request_id),TS.api.call("highlights.feedback",n)}}}),TS.menu.positionAt($(e.target),0,18)},isMessageHighlight:function(e){return!!TS.recaps_signal.canHaveHighlights()&&(e.recap&&e.recap.data&&e.recap.data.show_recap)},isMessageHighlightedUnfurl:function(e){return!!TS.recaps_signal.canHaveHighlights()&&_.get(e,"recap.data.is_unfurl")},markFeedbackForMessage:function(e,a){var t=TS.shared.getActiveModelOb(),i=o(t,e);i._sli_received_feedback=!0,i._sli_feedback_value=a,TS.recaps_signal.sendFeedback(t,i,a)},getDebugInfoFor:function(e){if(e){var a=TS.shared.getActiveModelOb(),t=o(a,e);return _.get(t,"recap.data")}},markMessagesAsHighlights:function(e,a){s={},s[a]={},_.each(e,function(e){s[a][e.ts]=!0})}});var e={},a=!1,t={},i=null,s={},r=function(e,a){return TS.api.call("highlights.list",{channel:e,messages:JSON.stringify(a),channel_open_ts:t.channel_open_ts,channel_open_last_read_ts:t.last_read_ts}).then(function(e){return i=e.request_id,e}).catch(function(e){throw e})},c=function(){TS.recaps_signal.canHaveHighlights()&&(a=null,t={})},n=function(e,a,t){if(!a.recap||_.get(a,"recap.data.generated_client_side"))return a.recap={promise:Promise.resolve(t).then(function(t){var i=(t.data.messages[e.id]||{})[a.ts]||{},r=_.get(a,"recap.data.justification");return a.recap.data=_.assign({},i,a.recap.data),a.recap.data.request_id=t.request_id,r||(a.recap.data.justification=TS.format.formatWithOptions(i.justification||"",a,{no_linking:!0})),!a.recap.data.show_recap&&s[e.id]&&s[e.id][a.ts]&&(a.recap.data.show_recap=!0),delete a.recap.data.generated_client_side,s[e.id]&&s[e.id][a.ts]&&delete s[e.id][a.ts],a}).catch(function(e){throw a.recap.error=e,e}),data:a.recap&&a.recap.data||null,error:null},a.recap.promise},d=function(e){if(TS.recaps_signal.canHaveHighlightsUI()){var a={},t={};e.forEach(function(e){TS.recaps_signal.isMessageHighlight(e)&&(a[e.ts]=!0),TS.recaps_signal.isMessageHighlightedUnfurl(e)&&(t[e.ts]=!0)});for(var i=g(),s=$(""),r=$(""),c=0;c<i.length;c+=1){var n=$(i[c]).data("ts");a[n]&&(s=s.add(i[c])),t[n]&&(r=r.add(i[c]))}return r.addClass("is_recap_unfurl"),s.addClass("is_recap"),s.length+r.length}},g=function(){return TS.model.archive_view_is_showing?$("#archive_msgs_scroller_div ts-message"):$("#msgs_scroller_div ts-message")},l=function(){var e;return e=TS.model.archive_view_is_showing?$("#archive_msgs_scroller_div ts-message.is_recap"):$("#msgs_scroller_div ts-message.is_recap"),e=e.filter(function(){return h($(this).data("ts"))})},o=function(e,a){return TS.model.archive_view_is_showing?TS.utility.msgs.getMsgByProp("ts",a,e._archive_msgs):TS.utility.msgs.getMsgByProp("ts",a,e.msgs)},h=function(e){return parseFloat(e)>parseFloat(t.last_read_ts)},u=function(e){for(var a=e.msgs,t=a.length,i=[],s=[],c=0;c<t;c+=1)if(!a[c].recap||_.get(a[c],"recap.data.generated_client_side")){var g=h(a[c].ts);g&&(s.push({ts:a[c].ts,is_unread:g}),i.push(a[c]))}var l=p(e,a);if(i.length){var o=r(e.id,s),u=[];return i.forEach(function(a){u.push(n(e,a,o))}),Promise.all(u).then(function(e){d(e),TS.client.msg_pane.rebuildMsgsWithReason("_retrieveHighlights msgs_to_fetch"),TS.recaps_signal.renderHighlightedMessages()}).catch(function(e){TS.error(e)})}l&&(TS.client.msg_pane.rebuildMsgsWithReason("_retrieveHighlights no msgs_to_fetch"),TS.recaps_signal.renderHighlightedMessages())},p=function(e,a){if(TS.boot_data.feature_sli_briefing&&!_.isEmpty(s)&&s[e.id]){var t=!1;return _.each(a,function(a){if(s[e.id][a.ts]){var i=TS.highlights_briefing.getMessageFromCache(e.id,a.ts);if(a.recap){var r=TS.highlights_briefing.getFeedbackFromCache(e.id,a.ts);"negative"!==r?(a.recap.data.generated_client_side=!0,a.recap.data.show_recap=!0,a.recap.data.justification=i&&i.justification||"",a.recap.data.feedback_options=i.feedback_options,a.recap.data.feedback=r,a.recap.data.request_id=i.request_id,a.recap.data.cached_request_id=i.cached_request_id,t=!0):(a.recap.data.generated_client_side=!0,a.recap.data.show_recap=!1,a.recap.data.feedback=r)}else a.recap={data:{show_recap:!0,generated_client_side:!0,justification:i&&i.justification||"",feedback_options:i.feedback_options,feedback:TS.highlights_briefing.getFeedbackFromCache(e.id,a.ts),request_id:i.request_id,cached_request_id:i.cached_request_id}}}}),t}}}()}},[2749]);